var C=Object.freeze({}),w=Object.freeze({}),y=(z,G,B=0)=>{if(G&&G.length&&z!==void 0){let H=G.length;for(let K=B;K<H&&z!==void 0&&z!==null;K++)z=z[G[K]]}return z};var k=(z)=>z=z===C?null:z instanceof Array?z:z!==void 0?[z]:null;class R{constructor(){this.selections=new Map}*iter(z){if(z instanceof Map){for(let[B,H]of z.entries())if(B!==w)for(let K of this.iter(H))yield K;let G=z.get(w);if(G)for(let B of G)yield B}else{let G=this.scope(z);if(G)for(let B of this.iter(G))yield B}}scope(z,G=!1){z=z instanceof Array?z:z!==void 0&&z!==null?[z]:[];let B=this.selections;for(let H of z)if(B.has(H))B=B.get(H);else if(G){let K=new Map;B.set(H,K),B=K}else return;return B}get(z){let G=this.scope(z);return G?G.get(w):void 0}add(z,G){let B=this.scope(z,!0);if(B.has(w))B.get(w).push(G);else B.set(w,[G]);return this}remove(z,G){let B=this.scope(z);if(!B)return!1;let H=B?B.get(w):void 0;if(!H)return!1;let K=H.indexOf(G);if(K===-1)return!1;return H.splice(K,1),!0}}class q{static*Walk(z,G=[]){if(z===null||z===void 0||typeof z!=="object");else if(z instanceof q)yield[z,G];else if(z instanceof Array)for(let B=0;B<z.length;B++)for(let H of q.Walk(z[B],[...G,B]))yield H;else if(Object.getPrototypeOf(z)===Object.prototype)for(let B in z)for(let H of q.Walk(z[B],[...G,B]))yield H}static Expand(z){if(z===void 0||z===null||typeof z!=="object")return z;else if(z instanceof q)return z.value;else if(z instanceof Array)return z.map((G)=>q.Expand(G));else if(Object.getPrototypeOf(z)===Object.prototype){let G={};for(let B in z)G[B]=q.Expand(z[B]);return G}else return z}constructor(z=C){this.isReactive=!0,this.value=z===C?void 0:z,this.revision=z===C?-1:0,this.subs=[],this.selections=void 0}select(z){z=z instanceof Array?z:[z],this.selections=this.selections??new R;let G=new N(this.value,z);return G.parent=this,G.path=z,this.selections.add(z,G),G}sub(z){return this.subs.push(z),this}unsub(z){let G=this.subs.indexOf(z);if(G>=0)this.subs.splice(G,1);return this}pub(z,G,B){for(let H of this.subs)H(z,G,B);return this}refresh(){throw Error(`${this.constructor.name}.refresh()} not implemented`)}get length(){if(this.revision===-1||this.value===null||this.value===void 0)return 0;else if(this.value instanceof Array)return this.value.length;else if(Object.getPrototypeOf(this.value)===Object.prototype)return Object.keys(this.value).length;else return 1}map(z){if(this.revision===-1)return null;else if(this.value===void 0)return null;else if(this.value instanceof Array)return this.value.map(z);else if(Object.getPrototypeOf(this.value)===Object.prototype){let G=[];for(let B of this.value)G[B]=z(this.value[B]);return G}else return[z(this.value)]}get(z=C){if(z===C)return this.value}}class N extends q{constructor(z,G){super(y(z,G));this.parent=z,this.path=G}refresh(){let z=y(this.parent.value,this.path);this.value=z,this.revision++,this.pub(z,this.path,this.parent)}set(z,G=C,B=!1){return G=k(G),this.parent.set(z,G?[...this.path,G]:this.path,B)}}var{Walk:m,Expand:D}=q;var g=(z)=>{if(z===void 0||z===null)return 0;else if(z instanceof Array)return z.length;else if(typeof z==="string")return z.length;else if(z instanceof Map||z instanceof Set)return z.size;else if(Object.getPrototypeOf(z)===Object.prototype)return Object.keys(z).length;return 1},h=new DOMParser,Z=Object.assign((z)=>z===void 0||z===null?Z.Null:z instanceof Array?Z.List:Object.getPrototypeOf(z)===Object.prototype?Z.Dict:typeof z==="number"?Z.Number:typeof z==="string"?Z.String:typeof z==="boolean"?Z.Boolean:Z.Object,{Null:1,Number:2,Boolean:3,String:4,Object:5,List:10,Dict:11}),Y=(z,G)=>{if(z===null||z===void 0||typeof z==="number"||typeof z==="string")return z;else if(z instanceof Array)return z.map(G);else if(z instanceof Map){let B=new Map;for(let[H,K]of z.entries())B.set(H,G(K,H));return B}else if(z instanceof Set){let B=new Set;for(let H of z)B.add(G(H,void 0));return B}else{let B={};for(let H in z)B[H]=G(z[H],H);return B}},c=(z,G)=>z===G,P=(z)=>{return z=D(z),z===null||z===void 0?"":typeof z==="number"?`${z}`:typeof z==="string"?z:JSON.stringify(z)},b=(z)=>{switch(z.nodeName){case"INPUT":case"TEXTAREA":case"SELECT":return!0;default:return!1}},O=(z,G)=>{switch(z.nodeType){case Node.TEXT_NODE:z.data=G;break;case Node.ELEMENT_NODE:if(b(z)){if(z.value!==G)z.value=G}else z.textContent=G;break}return z};class _{constructor(z,G,B){this.name=z,this.data=G,this.origin=B,this.current=void 0}}class F{constructor(z,G){this.template=z,this.data=G}}class ${static Path(z,G,B){let H=[];while(z!==G)H.splice(0,0,Array.prototype.indexOf.call(z.parentNode.childNodes,z)),z=z.parentNode;return B?B.concat(H):H}static Find(z,G,B=void 0){let H={},K=0,J=`[${z}]`,M=(L,Q,W)=>{let j=L.getAttribute(z);L.removeAttribute(z);let X=new $(L,Q,$.Path(L,Q,[W]));if(X=B?B(X,j):X,H[j]===void 0)H[j]=[X];else H[j].push(X);return K++,H};for(let L=0;L<G.length;L++){let Q=G[L];if(Q.matches&&Q.matches(J))M(Q,Q,L);if(Q.querySelectorAll)for(let W of Q.querySelectorAll(`[${z}]`))M(W,Q,L)}return K?H:null}constructor(z,G,B){this.node=z,this.parent=G,this.path=B,this.predicate=void 0,this.predicatePlaceholder=void 0}apply(z,G,B=!1){let H=z;for(let K of this.path)if(H instanceof Array)H=H[K];else H=H?H.childNodes[K]:H;return H?B?H:new T(H,this,G):null}static FindAttr(z,G){let B={},H=0;for(let K=0;K<G.length;K++){let J=G[K],M=(L)=>{if(!L.attributes)return;let Q=[];for(let W of L.attributes)if(W.name.startsWith(z)){let j=W.name.slice(z.length),X=W.value||j,E=L.getAttribute(j);Q.push(W.name);let I=new S(L,J,$.Path(L,J,[K]),j,X,E);if(!B[X])B[X]=[];B[X].push(I),H++}for(let W of Q)L.removeAttribute(W)};if(M(J),J.querySelectorAll)for(let L of J.querySelectorAll("*"))M(L)}return H?B:null}static FindEvent(z,G){let B={},H=0;for(let K=0;K<G.length;K++){let J=G[K],M=(L)=>{if(!L.attributes)return;let Q=[];for(let W of L.attributes)if(W.name.startsWith(z)){let j=W.name.slice(z.length),X=W.value||j;Q.push(W.name);let E=new x(L,J,$.Path(L,J,[K]),j,X);if(!B[X])B[X]=[];B[X].push(E),H++}for(let W of Q)L.removeAttribute(W)};if(M(J),J.querySelectorAll)for(let L of J.querySelectorAll("*"))M(L)}return H?B:null}}class S{constructor(z,G,B,H,K,J){this.node=z,this.parent=G,this.path=B,this.attrName=H,this.slotName=K,this.originalValue=J}apply(z,G){let B=z;for(let H of this.path)if(B instanceof Array)B=B[H];else B=B?B.childNodes[H]:B;return B?new f(B,this,G):null}}class f{constructor(z,G,B){this.node=z,this.template=G,this.parent=B,this.attrName=G.attrName,this.originalClasses=G.attrName==="class"?new Set((G.originalValue||"").split(/\s+/).filter(Boolean)):null,this.originalStyle=G.attrName==="style"?G.originalValue||"":null,this.appliedClasses=new Set,this.appliedStyles=new Map}render(z){if(this.attrName==="class")this._renderClass(z);else if(this.attrName==="style")this._renderStyle(z);else this._renderAttr(z)}_renderClass(z){for(let G of this.appliedClasses)if(!this.originalClasses.has(G))this.node.classList.remove(G);if(this.appliedClasses.clear(),z==null)return;if(typeof z==="object"&&!Array.isArray(z)){for(let[G,B]of Object.entries(z))if(B&&G&&G.trim())this.node.classList.add(G.trim()),this.appliedClasses.add(G.trim())}else{let G=Array.isArray(z)?z:String(z).split(/\s+/);for(let B of G)if(B&&typeof B==="string"&&B.trim())this.node.classList.add(B.trim()),this.appliedClasses.add(B.trim())}}_renderStyle(z){for(let G of this.appliedStyles.keys())this.node.style.removeProperty(G);if(this.appliedStyles.clear(),this.originalStyle){let G=document.createElement("div");G.style.cssText=this.originalStyle;for(let B of G.style)if(!this.node.style.getPropertyValue(B))this.node.style.setProperty(B,G.style.getPropertyValue(B))}if(z==null)return;if(typeof z==="object"){for(let[G,B]of Object.entries(z))if(B!=null){let H=G.replace(/([A-Z])/g,"-$1").toLowerCase();this.node.style.setProperty(H,B),this.appliedStyles.set(H,B)}}else{let G=document.createElement("div");G.style.cssText=z;for(let B of G.style){let H=G.style.getPropertyValue(B);this.node.style.setProperty(B,H),this.appliedStyles.set(B,H)}}}_renderAttr(z){if(z==null||z===!1)this.node.removeAttribute(this.attrName);else if(z===!0)this.node.setAttribute(this.attrName,"");else this.node.setAttribute(this.attrName,String(z))}}class x{constructor(z,G,B,H,K){this.node=z,this.parent=G,this.path=B,this.eventType=H,this.handlerName=K}apply(z,G){let B=z;for(let H of this.path)if(B instanceof Array)B=B[H];else B=B?B.childNodes[H]:B;return B?new U(B,this,G):null}}class U{constructor(z,G,B){this.node=z,this.template=G,this.parent=B,this.eventType=G.eventType,this.handlerName=G.handlerName}}class A{constructor(z){this.nodes=z,this.on=$.FindEvent("on:",z),this.in=$.Find("in",z),this.out=$.Find("out",z),this.inout=$.Find("inout",z),this.ref=$.Find("ref",z),this.when=$.Find("when",z,(G,B)=>{return G.predicate=Function(`return ((self,data,event)=>(${B}))`)(),G.predicatePlaceholder=document.createComment(B),G}),this.outAttr=$.FindAttr("out:",z),this.initializer=void 0,this.behavior=void 0,this.subs=void 0}new(z){return new V(this,z)}apply(z){return new F(this,z)}map(z){return Y(z,(G)=>new F(this,z))}init(z){return this.initializer=z,this}does(z){return this.behavior=Object.assign(this.behavior??{},z),this}sub(z,G=void 0){if(typeof z==="string"){if(!G)return this;if(this.subs===void 0)this.subs=new Map;if(this.subs.has(z))this.subs.get(z).push(G);else this.subs.set(z,[G])}else for(let B in z)this.sub(B,z[B]);return this}}class T{constructor(z,G,B){this.parent=B,this.node=z,this.mapping=new Map,this.placeholder=z.childNodes?[...z.childNodes]:null,this.predicatePlaceholder=G.predicate&&G.predicatePlaceholder?G.predicatePlaceholder.cloneNode(!0):null,this.template=G}render(z){let G=Z(z);if(g(z)===0){if(this.placeholder&&!this.placeholder[0]?.parentNode){let J=this.node.childNodes[0];for(let M of this.placeholder){if(!J||!J.nextSibling)this.node.appendChild(M);else this.node.insertBefore(M,J.nextSibling);J=M}}}else if(this.placeholder&&this.placeholder[0]?.parentNode)for(let J of this.placeholder)J.parentNode?.removeChild(J);let B=G===Z.List||G===Z.Dict?z:{_:z},H=null;for(let J in B){let M=B[J];if(!this.mapping.has(J)){let L=void 0;if(M instanceof F)L=M.template.new(this.parent),L.set(M.data,J).mount(this.node,H),H=L.nodes.at(-1);else if(b(this.node))O(this.node,P(M)),L=this.node;else if(M instanceof Node)this.node.appendChild(M),L=M;else L=document.createTextNode(P(M)),this.node.appendChild(L),H=L;this.mapping.set(J,L)}else{let L=this.mapping.get(J);if(L instanceof V)if(M instanceof F)if(M.template===L.template)L.set(M.data,J);else console.error("Not implemented: change in element");else L.set(M,J);else if(b(this.node))O(this.node,P(M));else if(L?.nodeType===Node.ELEMENT_NODE)if(M instanceof F)console.error("Not implemented: change from non UIInstance to UIInstance");else if(M instanceof Node)L.parentNode.replaceChild(M,L),this.mapping.set(J,M);else{let Q=document.createTextNode(P(M));L.parentNode.replaceChild(Q,L),this.mapping.set(J,Q)}else if(M instanceof F)console.error("Not implemented: change from non UIInstance to UIInstance");else if(M instanceof Node)L.parentNode.replaceChild(M,L),this.mapping.set(J,M);else O(L,P(M))}}let K=[];for(let[J,M]of this.mapping.entries())if(B[J]===void 0){if(M instanceof V)M.unmount();else if(M!==this.node)M.parentNode?.removeChild(M);K.push(J)}for(let J of K)this.mapping.delete(J)}show(){if(this.predicatePlaceholder&&this.predicatePlaceholder.parentNode)this.predicatePlaceholder.parentNode.replaceChild(this.node,this.predicatePlaceholder);return this}hide(){if(this.predicatePlaceholder&&this.node.parentNode)this.node.parentNode.replaceChild(this.predicatePlaceholder,this.node);return this}}class V{constructor(z,G){if(this.template=z,this.nodes=z.nodes.map((B)=>B.cloneNode(!0)),this.in=Y(z.in,(B)=>Y(B,(H)=>H.apply(this.nodes,this))),this.out=Y(z.out,(B)=>Y(B,(H)=>H.apply(this.nodes,this))),this.inout=Y(z.inout,(B)=>Y(B,(H)=>H.apply(this.nodes,this))),this.ref=Y(z.ref,(B)=>{let H=Y(B,(K)=>K.apply(this.nodes,this,!0));return H.length===1?H[0]:H}),this.on=Y(z.on,(B)=>Y(B,(H)=>H.apply(this.nodes,this))),this.when=Y(z.when,(B)=>Y(B,(H)=>H.apply(this.nodes,this))),this.outAttr=Y(z.outAttr,(B)=>Y(B,(H)=>H.apply(this.nodes,this))),this.parent=G,this.data=void 0,this.key=void 0,this.dataType=Z.Null,this.rendered=new Map,this.behavior=new Map,this.predicate=void 0,this.bind(),this.initial=void 0,this._renderer=()=>this.render(),z.initializer){let B=z.initializer();if(B){for(let H in B){let K=B[H];if(K&&K?.isReactive)K.sub(this._renderer)}this.initial=B}this.set(B)}}dispose(){if(this.initial)for(let z in this.initial){let G=this.initial[z];if(G&&G?.isReactive)G.unsub(this._renderer)}}bind(){for(let z in this.on)for(let G of this.on[z])this._bindEvent(z,G);for(let z of[this.in,this.inout])for(let G in z)for(let B of z[G])this._bindInput(G,B)}_bindEvent(z,G,B=this.template.behavior[z]){if(B)G.node.addEventListener(G.eventType,(H)=>{let K=B(this,this.data||{},H);if(K&&typeof K==="object"&&!Array.isArray(K))for(let J in K){let M=this.data?.[J];if(M?.isReactive)M.set(K[J])}})}_bindInput(z,G,B=this.template.behavior[z]){if(B){let H;switch(G.node.nodeName){case"INPUT":case"TEXTAREA":case"SELECT":H="input";break;case"FORM":H="submit";break;default:H="click"}G.node.addEventListener(H,(K)=>B(this,this.data||{},K))}}set(z,G=this.key){return this.key=G,this.render(z),this}update(z,G=!1){let B=G?!1:!0;if(!this.data)B=!1;else if(B)for(let H in z){let K=this.data[H],J=z[H];if(!c(K,J)){if(B=!1,K?.isReactive)K.unsub(this._renderer);if(J?.isReactive)J.sub(this._renderer)}}if(!B)this.render(this.data?Object.assign(this.data,z):z);return this}send(z,G){return this.pub(z,G)}pub(z,G){let B=new _(z,G,this);return this.parent?.onPub(B),B}onPub(z){z.current=this;let G=!0;if(this.template.subs){let B=this.template.subs.get(z.name);if(B)for(let H of B){let K=H(this,this.data,z);if(K===!1)return z;else if(K===null)G=!1}}return G&&this.parent?.onPub(z),z}mount(z,G){if(typeof z==="string"){let B=document.querySelector(z);if(!B)return console.error("Selector is empty, cannot mounted component",z,{component:this.template}),this;else z=B}if(z)if(this.nodes[0].parentNode!==z)if(G&&G.parentNode===z)for(let B of this.nodes)z.insertBefore(B,G.nextSibling),G=B;else for(let B of this.nodes)z.appendChild(B);else console.warn("Already mounted",this.nodes);else{console.warn("Unable to mount as node is undefined",{node:z,self:this});for(let B of this.nodes)B.parentNode?.removeChild(B)}return this}unmount(){for(let z of this.nodes)z.parentNode?.removeChild(z);return this}render(z=this.data){if(!this.template)return console.error("UIInstance.render() called on instance with undefined template",{instance:this}),this;let G=Z(z);if(!(this.template.out||this.template.inout||this.template.in||this.template.outAttr)){let B=P(z);for(let H of this.nodes)if(H.nodeType===Node.ELEMENT_NODE){O(H,B);break}}else{for(let B of[this.out,this.inout,this.in])if(B)for(let H in B){let K;if(this.template.behavior?.[H])if(this.behavior.has(H))K=this.behavior.get(H);else{let J=this.template.behavior[H];K=J(this,z,null),this.behavior.set(H,K)}else if(z&&H in z)K=D(z[H]);else K=z;for(let J of B[H])J.render(K)}this.behavior.clear();for(let B in this.when)for(let H of this.when[B])if(H.template.predicate(this,z))H.show();else H.hide();for(let B in this.outAttr){let H=z;if(this.template.behavior?.[B])if(this.behavior.has(B))H=this.behavior.get(B);else{let K=this.template.behavior[B];for(let J of this.outAttr[B]){let M=J.node.getAttribute(J.attrName);H=K(this,z,M,J.node),J.render(H)}this.behavior.set(B,H);continue}for(let K of this.outAttr[B])K.render(H)}}return this.data=z,this.dataType=G,this}}var u=(z,G=document)=>{if(z===null||z===void 0)throw Error(`ui() received ${z===null?"null":"undefined"} as selection. Expected a CSS selector string, an HTML string starting with "<", a DOM Node, or an array of DOM Nodes. Example: ui("#container") or ui("<div>Hello</div>")`);if(typeof z==="string"){let B=[];if(/\s*</.test(z))B=[...h.parseFromString(z,"text/html").body.childNodes];else for(let J of document.querySelectorAll(z))if(J.nodeName==="TEMPLATE")B=[...B,...J.content.childNodes];else B.push(J);if(B.length===0)console.warn(`ui() selector "${z}" did not match any elements`,{scope:G});let H=new A(B),K=(...J)=>H.apply(...J);return Object.assign(K,{isTemplate:!0,template:H,new:(...J)=>H.new(...J),init:(...J)=>(H.init(...J),K),map:(...J)=>(H.map(...J),K),apply:(...J)=>(H.apply(...J),K),does:(...J)=>(H.does(...J),K),on:(...J)=>(H.sub(...J),K),sub:(...J)=>(H.sub(...J),K)}),K}if(z instanceof Node||Array.isArray(z)){let B=z instanceof Node?[z]:z,H=new A([...B]),K=(...J)=>H.apply(...J);return Object.assign(K,{isTemplate:!0,template:H,new:(...J)=>H.new(...J),init:(...J)=>(H.init(...J),K),map:(...J)=>(H.map(...J),K),apply:(...J)=>(H.apply(...J),K),does:(...J)=>(H.does(...J),K),on:(...J)=>(H.sub(...J),K),sub:(...J)=>(H.sub(...J),K)}),K}throw Error(`ui() received an invalid selection type: ${typeof z}. Expected a string (CSS selector or HTML), a DOM Node, or an array of DOM Nodes. Received: ${z}`)},s=u;export{u as ui,Z as type,Y as remap,g as len,s as default};
