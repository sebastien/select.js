const String_startsWith=String.prototype.startsWith?function(s,t){return s.startsWith(t)}:function(s,t){return t&&s&&s.indexOf(t)==0};const String_endsWith=String.prototype.endsWith?function(s,t){return s.endsWith(t)}:function(s,t){var i=s.length-t.length;return i>=0&&s&&s.indexOf(t,i)==i};const _match=Element.prototype.matches?1:Element.prototype.mozMatchesSelector?2:Element.prototype.webkitMatchesSelector?3:null;const match=_match?(selector,node)=>{var index=undefined;if(String_endsWith(selector,":first")){selector=selector.substring(0,selector.length-6);index=0}if(index==undefined){try{switch(_match){case 1:return node&&node.matches&&node.matches(selector);break;case 2:return node&&node.mozMatchesSelector&&node.mozMatchesSelector(selector);case 3:return node&&node.webkitMatchesSelector&&node.webkitMatchesSelector(selector);default:console.error("select.match: browser not supported");exports.STATUS="FAILED";return node.matches(selector)}}catch(e){console.error("select.match: exception occured with selector",selector,"and node",node,":",e);return null}}else{var matches=exports.query(selector,undefined,index);return matches[index]==node}}:(selector,node)=>{if(String_endsWith(selector,":first")){return query(selector,node)==node}else{var parent=node.parentNode;if(parent){var matching=parent.querySelectorAll(selector);var i=0;for(var i=0;i<matching.length;i++){if(matching[i]===node){return true}}}return false}};export const query=(selector,scope,limit)=>{selector=selector.trim();if(!selector||selector.length==0){return[scope]}else if(selector[0]==">"){selector=selector.substr(1).trim();var i=Math.min(Math.max(selector.indexOf(">"),0),Math.max(selector.indexOf(" "),0));var selector_node=i>0?selector.substring(0,i):selector;var selector_child=i>0?selector.substring(i,selector.length):null;var matching=[];var nodes=(scope||document).childNodes;var result=null;for(var i=0;i<nodes.length;i++){var n=nodes[i];if(match(selector_node,n)&&n.nodeType==Node.ELEMENT_NODE){matching.push(n)}}if(selector_child){result=[];for(var i=0;i<matching.length;i++){result=result.concat(select.query(selector_child,matching[i]))}}else{result=matching}return result}else{var index=undefined;if(String_endsWith(selector,":first")){selector=selector.substring(0,selector.length-6);index=0}var result=[];var nodes=(scope||document).querySelectorAll(selector);var count=0;for(var i=0;i<nodes.length;i++){var node=nodes[i];if(node.nodeType==Node.ELEMENT_NODE){if(index===undefined){result.push(node);count+=1}else if(index==count){result.push(node);break}else{count+=1}}}return result}};export const filter=(selector,nodes)=>{var result=[];for(var i=0;i<nodes.length;i++){var node=nodes[i];if(match(selector,node)){result.push(node)}}return result};class Selection extends Array{constructor(selector,scope){super();var nodes=null;if(typeof selector=="string"){if(!scope){nodes=query(selector)}else{scope=exports.select(scope);nodes=scope.find(selector)}}else if(Selection.Is(selector)){nodes=selector;scope=selector.scope;selector=selector.selector;if(selector.scope&&scope!=selector.scope){console.error("Selection.new: given scope differs from first argument's",scope,"!=",selector.scope)}}else if(selector){nodes=Selection.AsElementList(selector)}this.selector=selector;this.scope=scope;this.isSelection=true;this.expand(nodes);return this}static Is(s){return s&&s.__class__===Selection}static IsList(s){return s instanceof Selection||s instanceof Array||s instanceof NodeList}static IsElement(node){return node&&typeof node.nodeType!="undefined"&&node.nodeType==Node.ELEMENT_NODE}static IsText(node){return node&&typeof node.nodeType!="undefined"&&node.nodeType==Node.TEXT_NODE}static IsNode(node){return node&&typeof node.nodeType!="undefined"}static IsDOM(node){return node&&typeof node.getBBox==="undefined"}static IsSVG(node){return typeof node.getBBox!="undefined"}static IsSelection(value){return value instanceof Selection}static AsElementList(value){if(!value){return value}else if(value.nodeType==Node.ELEMENT_NODE){return[value]}else if(value.nodeType==Node.DOCUMENT_FRAGMENT_NODE||value.nodeType==Node.DOCUMENT_NODE){var res=[];var child=value.firstElementChild;while(child){res.push(child);child=child.nextSibling}return res}else if(value===window){return Selection.AsElementList(window.document)}else if(Selection.IsList(value)){var res=[];for(var i=0;i<value.length;i++){res=res.concat(Selection.AsElementList(value[i]))}return res}else{return[]}}static Ensure(node){return Selection.Is(node)?node:new Selection(node)}find(selector){if(this.length==0){return exports.Empty}var nodes=[];for(var i=0;i<this.length;i++){var node=this[i];var q=query(selector,node);for(var j=0;j<q.length;j++){nodes.push(q[j])}}return new Selection(nodes,this)}filter(selector){if(typeof selector==="string"){return new Selection(filter(selector,this),this.length>0?this:undefined)}else if(typeof selector==="function"){return new Selection(Array.prototype.filter.apply(this,[selector]))}else{console.error("Selection.filter(): selector string or predicate expected, got",selector);return None}}iterate(callback){var nodes=this;for(var i=0;i<nodes.length;i++){if(callback(new Selection(nodes[i]),i)===false){break}}return this}like(selector){return this.is(selector)}is(selector){if(typeof selector==="string"){var result=this.length>0;for(var i=0;i<this.length;i++){if(!exports.match(selector,this[i])){result=false;break}}return result}else{return this.equals(selector)}}list(){return this.map(Selection.Ensure)}first(){return this.length<=1?this:select([this[0]],this)}last(){return this.length<=1?this:select([this[this.length-1]],this)}eq(index){return this.get(index)}get(index){index=index<0?this.length+index:index;if(this.length==1&&index==0){return this}else{return 0<=index<this.length?select([this[index]],this):exports.Empty}}next(selector){var nodes=[];for(var i=0;i<this.length;i++){var node=this[i];var sibling=node.nextElementSibling;if(sibling&&(!selector||match(selector,sibling))){nodes.push(sibling)}}return nodes.length>0?select(nodes,this):exports.Empty}prev(selector){return this.previous(selector)}previous(selector){var nodes=[];for(var i=0;i<this.length;i++){var node=this[i];var sibling=node.previousElementSibling;if(sibling&&(!selector||match(selector,sibling))){nodes.push(sibling)}}return nodes.length>0?select(nodes,this):exports.Empty}parent(selector){var nodes=[];for(var i=0;i<this.length;i++){var node=this[i].parentNode;if(node&&(!selector||match(selector,node))){nodes.push(node)}}return nodes.length>0?select(nodes,this):exports.Empty}ancestors(selector,limit){return this.parents(selector,limit)}parents(selector,limit){var nodes=[];var depth_limit=typeof limit==="number"?limit:-1;var node_limit=limit&&typeof limit!=="number"?select(limit):null;var is_function=typeof selector==="function";var is_string=typeof selector==="string";if(is_string&&String_endsWith(selector,":first")){selector=selector.substring(0,selector.length-6);index=0}for(var i=0;i<this.length;i++){var node=this[i].parentNode;while(node){var matches=true;if(selector){if(is_function){matches=selector(node,i)}else if(is_string){matches=match(selector,node)}}if(matches){nodes.push(node);if(depth_limit>=0&&nodes.length>=depth_limit){return select(nodes,this)}}node=node.parentNode;if(node_limit&&node_limit.contains(node)){node=null}}}return nodes.length>0?select(nodes,this):exports.Empty}children(selector){var nodes=[];for(var i=0;i<this.length;i++){var node=this[i];for(var j=0;j<node.childNodes.length;j++){var child=node.childNodes[j];if(Selection.IsElement(child)&&(!selector||match(selector,child))){nodes.push(child)}}}return nodes.length>0?select(nodes,this):exports.Empty}nodes(callback){var nodes=[];for(var i=0;i<this.length;i++){var node=this[i];for(var j=0;j<node.childNodes.length;j++){var child=node.childNodes[j];if(!callback||callback(child,i,node)!==false){nodes.push(child)}else{return nodes}}}return nodes}walk(callback){if(!callback){return this}var to_walk=[];var count=0;for(var i=0;i<this.length;i++){var node=this[i];to_walk.push(node);while(to_walk.length>0){var node=to_walk.pop();if(callback&&callback(node,count++)===false){return this}for(var j=0;j<node.childNodes.length;j++){to_walk.push(node.childNodes[j])}}}return this}append(value){if(this.length==0){return this}var node=this[0];if(Selection.Is(value)){for(var i=0;i<value.length;i++){node.appendChild(value[i])}}else if(value&&typeof value.nodeType!="undefined"){node.appendChild(value)}else if(Selection.IsList(value)){for(var i=0;i<value.length;i++){this.append(value[i])}}else if(typeof value=="string"){for(var i=0;i<this.length;i++){this[i].appendChild(document.createTextNode(value))}}else if(typeof value=="number"){for(var i=0;i<this.length;i++){this[i].appendChild(document.createTextNode(value))}}else if(value){console.error("Selection.append: value is expected to be Number, String, Node, [Node] or Selection, got",value)}return this}prepend(value){if(this.length==0){return this}var node=this[0];var child=node.firstChild;if(!child){return this.append(value)}if(Selection.Is(value)){for(var i=0;i<value.length;i++){node.insertBefore(value[i],child)}}else if(value&&typeof value.nodeType!="undefined"){node.insertBefore(value,child)}else if(Selection.IsList(value)){for(var i=0;i<value.length;i++){this.prepend(value[i])}}else if(typeof value=="string"){for(var i=0;i<this.length;i++){this[i].insertBefore(document.createTextNode(value),child)}}else if(typeof value=="number"){for(var i=0;i<this.length;i++){this[i].insertBefore(document.createTextNode(value),child)}}else if(value){console.error("Selection.prepend: value is expected to be Number, String, Node, [Node] or Selection, got",value)}return this}remove(){for(var i=0;i<this.length;i++){var node=this[i];if(node.parentNode){node.parentNode.removeChild(node)}}return this}extend(value){if(Selection.IsNode(value)){this.push(value)}else if(Selection.IsList(value)){for(var i=0;i<value.length;i++){this.extend(value[i])}}else{console.error("Selection.extend: value must be a node, selection or list, got",value)}return this}after(value){if(this.length==0){return this}var node=this[0];var scope=node;while(scope&&!Selection.IsElement(scope.nextSibling)){scope=scope.nextSibling}if(scope){if(Selection.Is(value)){for(var i=0;i<value.length;i++){scope.parentNode.insertBefore(value[i],scope)}}else if(typeof value.length!="undefined"){for(var i=0;i<value.length;i++){scope.parentNode.insertBefore(value[i],scope)}}else if(typeof value.nodeType!="undefined"){scope.parentNode.insertBefore(value,scope)}else{console.error("Selection.after: value is expected to be Node, [Node] or Selection, got",value)}}else{scope=node.parentNode;if(Selection.Is(value)){for(var i=0;i<value.length;i++){scope.appendChild(value[i])}}else if(typeof value.length!="undefined"){for(var i=0;i<value.length;i++){scope.appendChild(value[i])}}else if(typeof value.nodeType!="undefined"){scope.appendChild(value)}else{console.error("Selection.after: value is expected to be Node, [Node] or Selection, got",value)}}return this}before(value){if(this.length==0){return this}var node=this[0];var scope=node;var parent=scope.parentNode;if(Selection.Is(value)){for(var i=0;i<value.length;i++){parent.insertBefore(value[i],scope)}}else if(typeof value.length!="undefined"){for(var i=0;i<value.length;i++){parent.insertBefore(value[i],scope)}}else if(typeof value.nodeType!="undefined"){parent.insertBefore(value,scope)}else{console.error("Selection.before: value is expected to be Node, [Node] or Selection, got",value)}return this}replaceWith(value){if(this.length==0){console.warn("Selection.replaceWith: current selection is empty, so given nodes will be removed");if(Selection.IsNode(value)){if(value.parentNode){value.parentNode.removeChild(value)}}else if(Selection.IsSelection(value)||Selection.IsList(value)){for(var i=0;i<value.length;i++){var node=value[i];if(node.parentNode){node.parentNode.removeChild(node)}}}return this}else{var scope=this[0];var parent=scope.parentNode;var added=[];if(Selection.IsNode(value)){if(parent){parent.insertBefore(value,scope)}added.push(value)}else if(Selection.IsSelection(value)||Selection.IsList(value)){var added=[];for(var i=0;i<value.length;i++){var n=value[i];if(parent){parent.insertBefore(n,scope)}added.push(n)}}else{console.error("Selection.replaceWith: value is expected to be Node, [Node] or Selection, got",value)}while(this.length>0){var n=this.pop();if(n.parentNode){n.parentNode.removeChild(n)}}while(added.length>0){this.push(added.pop())}}return this}equals(node){if(typeof node==="string"){return this.equals(query(node))}else if(node instanceof Array){if(node.length!=this.length){return false}for(var i=0;i<this.length;i++){if(node[i]!=this[i]){return false}}return true}else if(Selection.IsElement(node)){return this.length==1&&this[0]===node}else{return false}}contains(node){if(node instanceof Array||Selection.IsElement(node)){var found=true;for(var i=0;found&&i<this.length;i++){found=this.indexOf(node[i])>=0}return found}else{return this.indexOf(node)>=0}}wrap(node){node=$(node);node.add(this);return node}clone(value){if(this.length==0){return this}var node=this[0];return select(node.cloneNode(true),this)}empty(){for(var i=0;i<this.length;i++){var node=this[i];while(node.firstChild){node.removeChild(node.firstChild)}}return this}isEmpty(){return this.length==0}val(){return this.value()}value(value){if(typeof value=="undefined"){for(var i=0;i<this.length;i++){var node=this[i];if(typeof node.value!="undefined"){return node.value}else if(node.hasAttribute("contenteditable")){return node.textContent}}return undefined}else{value=""+value;for(var i=0;i<this.length;i++){var node=this[i];if(typeof node.value!="undefined"){node.value=value}else if(node.hasAttribute("contenteditable")){node.textContent=value}}return this}}text(value){var result=undefined;if(typeof value=="undefined"){for(var i=0;i<this.length;i++){var node=this[i];result=node.textContent;if(result){return result}}return result}else{value=typeof value==="string"?value:JSON.stringify(value);for(var i=0;i<this.length;i++){var node=this[i];node.textContent=value}return this}}html(value){return this.contents(value)}contents(value){var result=undefined;if(typeof value=="undefined"){for(var i=0;i<this.length;i++){var node=this[i];result=node.innerHTML;if(result){return result}}return result}else{if(!value||typeof value==="string"||typeof value==="number"){value=value||"";for(var i=0;i<this.length;i++){var node=this[i];node.innerHTML=value}return this}else{return this.empty().append(value)}}}attr(name,value){if(typeof name==="string"){if(arguments.length==1){for(var i=0;i<this.length;i++){var node=this[i];if(node.hasAttribute(name)){return node.getAttribute(name)}}return undefined}else{value=typeof value==="string"?value:value===null?value:JSON.stringify(value);for(var i=0;i<this.length;i++){var node=this[i];if(value===null){if(node.hasAttribute(name)){node.removeAttribute(name)}}else{node.setAttribute(name,value)}}return this}}else if(name){for(var k in name){this.attr(k,name[k])}return this}return this}data(name,value,serialize){if(!name){for(var i=0;i<this.length;i++){var node=this[i];if(node.dataset){var r={};for(var k in node.dataset){v=node.dataset[k];try{v=JSON.parse(v)}catch(e){}r[k]=v}return r}else{var a=node.attributes;var r=undefined;for(var j=0;j<a.length;j++){var _=a[j];var n=_.name;if(String_startsWith(n,"data-")){var v=_.value;try{v=JSON.parse(v)}catch(e){}r=r||{};r[n.substring(5,n.length)]=v}}return r}}return undefined}else if(typeof name==="string"){var data_name="data-"+name;if(typeof value=="undefined"){for(var i=0;i<this.length;i++){var node=this[i];var serialized=undefined;var attr_value=undefined;if(node.hasAttribute(data_name)){attr_value=node.getAttribute(data_name)}var value=typeof node.dataset!="undefined"?node.dataset[name]:attr_value;try{value=JSON.parse(value)}catch(e){}if(typeof value!="undefined"){return value}}return undefined}else{var serialized=typeof value==="string"?value:JSON.stringify(value);for(var i=0;i<this.length;i++){var node=this[i];if(typeof node.dataset!="undefined"){node.dataset[name]=serialized}else{node.setAttribute(data_name,serialized)}}return this}}else{for(var k in name){this.data(k,name[k])}return this}}addClass(className){if(className instanceof Array){for(var i=0;i<className.length;i++){this.addClass(className[i])}return this}if(arguments.length>1){for(var i=0;i<arguments.length;i++){this.addClass(arguments[i])}return this}for(var i=0;i<this.length;i++){var node=this[i];if(node.classList){node.classList.add(className)}else{var c=node.getAttribute("class");if(c&&c.length>0){var m=c.indexOf(className);var la=c.length||0;var lc=className.length;var p=n-1;var n=m+lc;if(!((m==0||c[p]==" ")&&(n==la||c[n]==" "))){node.setAttribute(c+" "+className)}}else{node.setAttribute(className)}}}return this}removeClass(className){for(var i=0;i<this.length;i++){var node=this[i];if(node.classList){node.classList.remove(className)}else{var c=node.getAttribute("class");if(c&&c.length>0){var m=c.indexOf(className);if(m>=0){var la=c.length||0;var lc=className.length;var nc="";while(m>=0){var p=n-1;var n=m+lc;if((m==0||c[p]==" ")&&(n==la||c[n]==" ")){nc+=c.substr(0,m)}else{nc+=c.substr(0,m+lc)}c=c.substr(m+lc)}nc+=c;node.setAttribute("class",nc)}}}}return this}hasClass(name){var lc=(name||"").length;for(var i=0;i<this.length;i++){var node=this[i];if(typeof node.classList!="undefined"){return node.classList.contains(name)}else{var c=node.className||"";if(c&c.length>0){var m=c.indexOf(name);if(m>=0){var la=c.length||0;var p=m-1;var n=m+lc+1;if((m==0||c[p]==" ")&&(m==la||c[n]==" ")){return true}}}}}return false}toggleClass(name,value){var sel=select();var is_function=value instanceof Function;for(var i=0;i<this.length;i++){var node=this[i];var v=is_function?value(node,i):value;sel.set(this[i]);if(typeof value=="undefined"){if(sel.hasClass(name)){sel.removeClass(name)}else{sel.addClass(name)}}else if(v&&!sel.hasClass(name)){sel.addClass(name)}else if(!v&&sel.hasClass(name)){sel.removeClass(name)}}return this}css(name,value){if(typeof name==="string"){if(typeof value==="undefined"){for(var i=0;i<this.length;i++){var style=document.defaultView.getComputedStyle(this[i],null)[name];if(typeof style!="undefined"){return style}}return undefined}else{value=typeof value==="string"?value:value+"px";for(var i=0;i<this.length;i++){this[i].style[name]=value}return this}}else{for(var k in name){this.css(k,name[k])}return this}return this}width(){for(var i=0;i<this.length;i++){var node=this[i];var nb=node.getBoundingClientRect();return nb.right-nb.left}return 0}height(){for(var i=0;i<this.length;i++){var node=this[i];var nb=node.getBoundingClientRect();return nb.bottom-nb.top}return 0}offset(){for(var i=0;i<this.length;i++){var node=this[i];if(Selection.IsDOM(node)){return{left:node.offsetLeft,top:node.offsetTop}}else{var nb=node.getBoundingClientRect();var pb=node.parentNode.getBoundingClientRect();return{left:nb.left-pb.left,top:nb.top-pb.top}}}return undefined}scrollTop(value){var has_value=value!==undefined;for(var i=0;i<this.length;i++){var node=this[i];if(Selection.IsDOM(node)){if(has_value){node.scrollTop=value}else{return node.scrollTop}}else{console.error("Selection.scrollTop: Not implemented for SVG")}}return undefined}scrollLeft(value){var has_value=value!==undefined;for(var i=0;i<this.length;i++){var node=this[i];if(Selection.IsDOM(node)){if(has_value){node.scrollLeft=value}else{return node.scrollLeft}}else{console.error("Selection.scrollLeft: Not implemented for SVG")}}return undefined}focus(callbacl){if(typeof callback=="undefined"){for(var i=0;i<this.length;i++){var node=this[i];if(node.focus){node.focus();if(document.activeElement==node){return this}}}return this}else{return this.bind("select",callback)}}select(callback){if(typeof callback=="undefined"){var s=window.getSelection();s.removeAllRanges();for(var i=0;i<this.length;i++){var node=this[i];if(node.select){node.select()}else{var r=new Range;if(node.nodeType==node.TEXT_NODE){r.selectNode(node)}else{r.selectNodeContents(node)}s.removeAllRanges();s.addRange(r)}}return this}else{return this.bind("select",callback)}}bind(event,callback,capture){capture=capture&&true;for(var i=0;i<this.length;i++){var node=this[i];node.addEventListener(event,callback,capture)}return this}unbind(event,callback){for(var i=0;i<this.length;i++){var node=this[i];node.removeEventListener(event,callback)}return this}trigger(event){if(typeof event==="string"){var name=event;event=document.createEvent("HTMLEvents");event.initEvent(name,true,true)}for(var i=0;i<this.length;i++){var node=this[i];node.dispatchEvent(event)}return this}node(index){index=index||0;index=index<0?this.length-index:index;if(index>=0&&index<this.length){return this[index]}else{return undefined}}set(value){return this.clear().expand(value)}copy(value){return(new Selection).expand(value)}clear(length){length=length||0;super.splice(length,this.length-length);return this}expand(element){if(element==window||element==document){element=document.firstElementChild}if(!element||element.length==0){return this}else if(typeof element==="string"){return this.expand(query(element))}else if(Selection.IsElement(element)){this.push(element)}else if(element.nodeType==Node.DOCUMENT_NODE){this.expand(element.firstElementChild)}else if(element instanceof NodeList||Selection.IsList(element)){for(var i=0;i<element.length;i++){this.expand(element[i])}}else{console.error("Selection.expand: Unsupported argument",element)}return this}}export const select=(selector,scope)=>{return Selection.Is(selector)&&!scope?selector:new Selection(selector,scope)};select.Selection=Selection;select.VERSION="1.0.0b0";select.NAME="select";select.LICENSE="http://ffctn.com/doc/licenses/bsd.html";select.STATUS="LOADED";select.Empty=new Selection;select.isNode=Selection.IsNode;select.isText=Selection.IsText;select.filter=filter;select.match=match;select.query=query;select.select=select;export const S=select;export const $=select;export default select;
