export const len=n=>{const e=typeof n;return n==null?0:n instanceof Array||e==="string"?n.length:n instanceof Map||n instanceof Set?n.size:Object.getPrototypeOf(n)===Object.prototype?Object.keys(e).length:1};const g=new DOMParser;export const type=Object.assign(n=>n==null?type.Null:n instanceof Array?type.List:Object.getPrototypeOf(n)===Object.prototype?type.Dict:typeof n=="number"?type.Number:typeof n=="string"?type.String:typeof n=="boolean"?type.Boolean:type.Object,{Null:1,Number:2,Boolean:3,String:4,Object:5,List:10,Dict:11}),remap=(n,e)=>{if(n==null||typeof n=="number"||typeof n=="string")return n;if(n instanceof Array)return n.map(e);if(n instanceof Map){const s=new Map;for(const[t,i]of n.entries())s.set(t,e(i,t));return s}else if(n instanceof Set){const s=new Set;for(const t of n)s.add(e(t,void 0));return s}else{const s={};for(const t in n)s[t]=e(n[t],t);return s}};const w=(n,e)=>n===e,l=n=>n==null?"":typeof n=="number"?`${n}`:typeof n=="string"?n:JSON.stringify(n),N=n=>{switch(n.nodeName){case"INPUT":case"TEXTAREA":case"SELECT":return!0;default:return!1}},m=(n,e)=>{switch(n.nodeType){case Node.TEXT_NODE:n.data=e;break;case Node.ELEMENT_NODE:N(n)?n.value!==e&&(n.value=e):n.textContent=e;break}return n},P=n=>{const e=new Set;return[new Proxy(n,{get(s,t){return e.add(t),s[t]}}),e]};class T{constructor(e,s,t){this.name=e,this.data=s,this.origin=t,this.current=void 0}}class f{constructor(e,s){this.template=e,this.data=s}}class d{static Path(e,s,t){const i=[];for(;e!==s;)i.splice(0,0,Array.prototype.indexOf.call(e.parentNode.childNodes,e)),e=e.parentNode;return t?t.concat(i):i}static Find(e,s,t=void 0){const i={};let o=0;const h=`[${e}]`,r=(c,a,b)=>{const u=c.getAttribute(e);c.removeAttribute(e);let p=new d(c,a,d.Path(c,a,[b]));return p=t?t(p,u):p,i[u]===void 0?i[u]=[p]:i[u].push(p),o++,i};for(let c=0;c<s.length;c++){const a=s[c];if(a.matches&&a.matches(h)&&r(a,a,c),a.querySelectorAll)for(const b of a.querySelectorAll(`[${e}]`))r(b,a,c)}return o?i:null}constructor(e,s,t){this.node=e,this.parent=s,this.path=t,this.predicate=void 0,this.predicatePlaceholder=void 0}apply(e,s,t=!1){let i=e;for(const o of this.path)i instanceof Array?i=i[o]:i=i&&i.childNodes[o];return i?t?i:new k(i,this,s):null}}class E{constructor(e){this.nodes=e,this.on=d.Find("on",e),this.in=d.Find("in",e),this.out=d.Find("out",e),this.inout=d.Find("inout",e),this.ref=d.Find("ref",e),this.when=d.Find("when",e,(s,t)=>(s.predicate=new Function(`return ((self,data,event)=>(${t}))`)(),s.predicatePlaceholder=document.createComment(t),s)),this.initializer=void 0,this.behavior=void 0,this.subs=void 0}new(e){return new y(this,e)}apply(e){return new f(this,e)}map(e){return remap(e,s=>new f(this,e))}init(e){return this.initializer=e,this}does(e){return this.behavior=Object.assign(this.behavior??{},e),this}sub(e,s=void 0){if(typeof e=="string"){if(!s)return this;this.subs===void 0&&(this.subs=new Map),this.subs.has(e)?this.subs.get(e).push(s):this.subs.set(e,[s])}else for(const t in e)this.sub(t,e[t]);return this}}class k{constructor(e,s,t){this.parent=t,this.node=e,this.mapping=new Map,this.placeholder=e.childNodes?[...e.childNodes]:null,this.predicatePlaceholder=s.predicate&&s.predicatePlaceholder?s.predicatePlaceholder.cloneNode(!0):null,this.template=s}render(e){const s=type(e);if(len(e)===0){if(this.placeholder&&!this.placeholder[0]?.parentNode){let h=this.node.childNodes[0];for(const r of this.placeholder)!h||!h.nextSibling?this.node.appendChild(r):this.node.insertBefore(r,h.nextSibling),h=r}}else if(this.placeholder&&this.placeholder[0]?.parentNode)for(const h of this.placeholder)h.parentNode?.removeChild(h);const t=s===type.List||s===type.Dict?e:{_:e};let i=null;for(const h in t){const r=t[h];if(this.mapping.has(h)){const c=this.mapping.get(h);if(c instanceof y)r instanceof f?r.template===c.template?c.set(r.data,h):console.error("Not implemented: change in element"):c.set(r,h);else if(N(this.node))m(this.node,l(r));else if(c?.nodeType===Node.ELEMENT_NODE)if(r instanceof f)console.error("Not implemented: change from non UIInstance to UIInstance");else if(r instanceof Node)c.parentNode.replaceChild(r,c),this.mapping.set(h,r);else{const a=document.createTextNode(l(r));c.parentNode.replaceChild(a,c),this.mapping.set(h,a)}else r instanceof f?console.error("Not implemented: change from non UIInstance to UIInstance"):r instanceof Node?(c.parentNode.replaceChild(r,c),this.mapping.set(h,r)):m(c,l(r))}else{let c;r instanceof f?(c=r.template.new(this.parent),c.set(r.data,h).mount(this.node,i),i=c.nodes.at(-1)):N(this.node)?(m(this.node,l(r)),c=this.node):r instanceof Node?(this.node.appendChild(r),c=r):(c=document.createTextNode(l(r)),this.node.appendChild(c),i=c),this.mapping.set(h,c)}}const o=[];for(const[h,r]of this.mapping.entries())t[h]===void 0&&(r instanceof y?r.unmount():r!==this.node&&r.parentNode?.removeChild(r),o.push(h));for(const h of o)this.mapping.delete(h)}show(){return this.predicatePlaceholder&&this.predicatePlaceholder.parentNode&&this.predicatePlaceholder.parentNode.replaceChild(this.node,this.predicatePlaceholder),this}hide(){return this.predicatePlaceholder&&this.node.parentNode&&this.node.parentNode.replaceChild(this.predicatePlaceholder,this.node),this}}class O{constructor(){this.value=void 0,this.dependencies=new Set}}class y{constructor(e,s){if(this.template=e,this.nodes=e.nodes.map(t=>t.cloneNode(!0)),this.in=remap(e.in,t=>remap(t,i=>i.apply(this.nodes,this))),this.out=remap(e.out,t=>remap(t,i=>i.apply(this.nodes,this))),this.inout=remap(e.inout,t=>remap(t,i=>i.apply(this.nodes,this))),this.ref=remap(e.ref,t=>{const i=remap(t,o=>o.apply(this.nodes,this,!0));return i.length===1?i[0]:i}),this.on=remap(e.on,t=>remap(t,i=>i.apply(this.nodes,this))),this.when=remap(e.when,t=>remap(t,i=>i.apply(this.nodes,this))),this.parent=s,this.data=void 0,this.key=void 0,this.dataType=type.Null,this.rendered=new Map,this.behavior=new Map,this.predicate=void 0,this.bind(),this.initial=void 0,this._renderer=()=>this.render(),e.initializer){const t=e.initializer();if(t){for(const i in t){const o=t[i];o&&o?.isReactive&&o.sub(this._renderer)}this.initial=t}this.set(t)}}dispose(){if(this.initial)for(const e in this.initial){const s=this.initial[e];s&&s?.isReactive&&s.unsub(this._renderer)}}bind(){for(const e of[this.on,this.in,this.inout])for(const s in e)for(const t of e[s])this._bind(s,t)}_bind(e,s,t=this.template.behavior[e]){if(t instanceof Function&&(t={_:t}),t)for(let i in t){const o=t[i];if(i==="_")switch(s.node.nodeName){case"INPUT":case"TEXTAREA":case"SELECT":i="input";break;case"FORM":i="submit";break;default:i="click"}s.node.addEventListener(i,h=>o(this,this.data||{},h))}}set(e,s=this.key){return this.key=s,this.render(e),this}update(e,s=!1){let t=!s;if(!this.data)t=!1;else if(t)for(const i in e){const o=this.data[i],h=e[i];w(o,h)||(t=!1,o?.isReactive&&o.unsub(this._renderer),h?.isReactive&&h.sub(this._renderer))}return t||this.render(this.data?Object.assign(this.data,e):e),this}send(e,s){return this.pub(e,s)}pub(e,s){const t=new T(e,s,this);return this.parent?.onPub(t),t}onPub(e){e.current=this;let s=!0;if(this.template.subs){const t=this.template.subs.get(e.name);if(t)for(const i of t){const o=i(this,this.data,e);if(o===!1)return e;o===null&&(s=!1)}}return s&&this.parent?.onPub(e),e}mount(e,s){if(typeof e=="string"){const t=document.querySelector(e);if(t)e=t;else return console.error("Selector is empty, cannot mounted component",e,{component:this.template}),this}if(e)if(this.nodes[0].parentNode!==e)for(const t of this.nodes)e.appendChild(t);else console.warn("Already mounted",this.nodes);else{console.warn("Unable to mount as node is empty");for(const t of this.nodes)t.parentNode?.removeChild(t)}return this}unmount(){for(const e of this.nodes)e.parentNode?.removeChild(e);return this}render(e=this.data){const s=type(e);if(this.template.out||this.template.inout||this.templates.inout){for(const t of[this.out,this.inout,this.in])if(t)for(const i in t){let o=e;if(this.template.behavior[i])if(this.behavior.has(i))o=this.behavior.get(i);else{const h=this.template.behavior[i];o=h(this,e,null),this.behavior.set(i,o)}for(const h of t[i])h.render(o)}this.behavior.clear();for(const t in this.when)for(const i of this.when[t])i.template.predicate(self,e)?i.show():i.hide()}else{const t=l(e);for(const i of this.nodes)if(i.nodeType===Node.ELEMENT_NODE){m(i,t);break}}return this.data=e,this.dataType=s,this}}export const ui=(n,e=document)=>{if(typeof n=="string"){let s=[];if(/\s*</.test(n))s=[...g.parseFromString(n,"text/html").body.childNodes];else for(const o of document.querySelectorAll(n))o.nodeName==="TEMPLATE"?s=[...s,...o.content.childNodes]:s.push(o);const t=new E(s),i=(...o)=>t.apply(...o);return Object.assign(i,{isTemplate:!0,template:t,new:(...o)=>t.new(...o),init:(...o)=>t.init(...o),map:(...o)=>t.map(...o),apply:(...o)=>t.apply(...o),does:(...o)=>(t.does(...o),i),on:(...o)=>(t.sub(...o),i),sub:(...o)=>(t.sub(...o),i)}),i}};export default ui;
